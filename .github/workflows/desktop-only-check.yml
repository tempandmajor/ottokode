name: ğŸ–¥ï¸ Desktop-Only Development Policy Enforcement

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  enforce-desktop-only:
    name: ğŸ›¡ï¸ Enforce Desktop-Only Policy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ğŸ” Check Desktop-Only Development Policy
      run: |
        echo "ğŸ¯ DESKTOP-ONLY DEVELOPMENT POLICY CHECK"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Check for web-app feature development violations
        WEB_APP_VIOLATIONS=$(git diff --name-only HEAD~1..HEAD | grep -E "^web-app/src/(components|services|hooks|utils|store)/" | grep -v -E "(README|\.md$|package\.json$|\.test\.|\.spec\.)") || true

        if [ ! -z "$WEB_APP_VIOLATIONS" ]; then
          echo ""
          echo "âŒ POLICY VIOLATION: Web-app feature development detected!"
          echo "ğŸš« PROHIBITED: New features in web-app/ directory"
          echo ""
          echo "ğŸ” Violating files:"
          echo "$WEB_APP_VIOLATIONS" | while read file; do
            echo "  â€¢ $file"
          done
          echo ""
          echo "ğŸ“‹ POLICY: All new features must be in desktop app (src/)"
          echo "ğŸ“– See: DESKTOP_ONLY_DEVELOPMENT_POLICY.md"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        fi

        # Check for desktop app development (positive)
        DESKTOP_FILES=$(git diff --name-only HEAD~1..HEAD | grep -E "^src/" | head -10) || true
        if [ ! -z "$DESKTOP_FILES" ]; then
          echo "âœ… Desktop app development detected - Policy compliant!"
          echo "ğŸš€ Desktop files modified:"
          echo "$DESKTOP_FILES" | while read file; do
            echo "  â€¢ $file"
          done
          echo ""
        fi

        # Check for policy documentation updates
        POLICY_FILES=$(git diff --name-only HEAD~1..HEAD | grep -E "(DESKTOP_ONLY|desktop-only)" | head -5) || true
        if [ ! -z "$POLICY_FILES" ]; then
          echo "ğŸ“‹ Policy documentation updated:"
          echo "$POLICY_FILES" | while read file; do
            echo "  â€¢ $file"
          done
          echo ""
        fi

        echo "ğŸ¯ Desktop-Only Policy: âœ… PASSED"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: ğŸ“Š Generate Policy Report
      if: always()
      run: |
        echo "ğŸ“Š DEVELOPMENT ACTIVITY REPORT" >> policy-report.txt
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> policy-report.txt
        echo "ğŸ—“ï¸ Date: $(date)" >> policy-report.txt
        echo "ğŸ”€ Branch: $GITHUB_REF_NAME" >> policy-report.txt
        echo "ğŸ‘¤ Author: $GITHUB_ACTOR" >> policy-report.txt
        echo "" >> policy-report.txt

        TOTAL_FILES=$(git diff --name-only HEAD~1..HEAD | wc -l)
        DESKTOP_FILES=$(git diff --name-only HEAD~1..HEAD | grep -E "^src/" | wc -l)
        WEB_FILES=$(git diff --name-only HEAD~1..HEAD | grep -E "^web-app/" | wc -l)

        echo "ğŸ“ˆ File Change Summary:" >> policy-report.txt
        echo "  â€¢ Total files changed: $TOTAL_FILES" >> policy-report.txt
        echo "  â€¢ Desktop app files: $DESKTOP_FILES" >> policy-report.txt
        echo "  â€¢ Web app files: $WEB_FILES" >> policy-report.txt
        echo "" >> policy-report.txt

        if [ $DESKTOP_FILES -gt 0 ]; then
          echo "âœ… Policy Compliance: GOOD" >> policy-report.txt
          echo "ğŸ¯ Focus: Desktop-first development âœ“" >> policy-report.txt
        else
          echo "âš ï¸ Policy Compliance: REVIEW NEEDED" >> policy-report.txt
          echo "ğŸ¯ Focus: Ensure desktop app development" >> policy-report.txt
        fi

        echo "" >> policy-report.txt
        echo "ğŸ“– Policy: DESKTOP_ONLY_DEVELOPMENT_POLICY.md" >> policy-report.txt

        cat policy-report.txt

    - name: ğŸ’¬ Comment Policy Status (on PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          // Check if policy report exists
          let reportContent = 'ğŸ“Š Desktop-Only Policy Check: âœ… PASSED\n\n';

          try {
            reportContent = fs.readFileSync('policy-report.txt', 'utf8');
          } catch (e) {
            reportContent = 'ğŸ“Š Desktop-Only Policy Check completed successfully.';
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ–¥ï¸ Desktop-Only Development Policy Check\n\n${reportContent}\n\n---\n*Automated policy enforcement by GitHub Actions*`
          });

  validate-desktop-features:
    name: ğŸ” Validate Desktop Features
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'feat:') || contains(github.event.head_commit.message, 'feature:')

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Check Feature Implementation Location
      run: |
        echo "ğŸ” FEATURE VALIDATION: Checking implementation location"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Look for new feature files
        NEW_FEATURES=$(git diff --name-only HEAD~1..HEAD | grep -E "\.(ts|tsx|js|jsx)$" | grep -E "(component|service|hook|util)" | head -10) || true

        if [ ! -z "$NEW_FEATURES" ]; then
          echo "ğŸ†• New feature files detected:"
          echo "$NEW_FEATURES" | while read file; do
            if [[ $file == src/* ]]; then
              echo "  âœ… $file (Desktop App - Compliant)"
            elif [[ $file == web-app/* ]]; then
              echo "  âŒ $file (Web App - Policy Violation)"
            else
              echo "  â„¹ï¸ $file (Other location)"
            fi
          done
          echo ""

          # Check if any features are in web-app
          WEB_FEATURES=$(echo "$NEW_FEATURES" | grep "^web-app/" || true)
          if [ ! -z "$WEB_FEATURES" ]; then
            echo "âŒ FEATURE POLICY VIOLATION!"
            echo "ğŸš« New features detected in web-app/ directory"
            echo "ğŸ“‹ REQUIRED: Move features to desktop app (src/)"
            exit 1
          fi
        fi

        echo "ğŸ¯ Feature Implementation: âœ… COMPLIANT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"